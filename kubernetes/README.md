## Deploying Kubernetes Dashboard

Kubernetes Dashboard is a web-based Kubernetes UI. Here, we will use it to get an overview of
applications running on the cluster. Let's deploy Kubernetes Dasboard :-
```sh
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
```
Currently, Kubernetes Dashboard only supports ServiceAccounts.

Let's create a ServiceAccount named `cluster-admin` which represents the cluster admin.
```sh
kubectl apply -f ./yaml/serviceaccounts/cluster-admin
```

You can access the Kubernetes dashboard at *http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/*, after running these commands :-
```sh
# Generate a JWT for the ServiceAccount, using the Kubernetes TokenRequest API
kubectl -n kubernetes-dashboard create token cluster-admin

# The proxy provides a secure connection between the cluster (API Server) and the client.
kubectl proxy
```

## Managing physical users (Authentication and Authorization)

Let's say, our database engineering team consists of 1 person - Adam.

Adam will first generate a private key.
```sh
mkdir -p users/adam && \
  openssl genrsa -out ./users/adam/private-key 2048
```

Then he will create the Certificate Signing Request (CSR) -
```sh
openssl req \
  -new \
  -key ./users/adam/private-key \
  -out ./users/adam/csr \
  -subj "/CN=adam"

# View the CSR
openssl req -in ./users/adam/csr -noout -text

# Base64 encoding the CSR
cat ./users/adam/csr | base64 | tr -d "\n"
```

He will then share the base 64 encoded CSR with me (the cluster admin ðŸ˜Ž). Using that, I will create
a `Kubernetes CSR object` based on this template - *./certificate-signing-request.cue*. I will then
approve the CSR using this command :-
```sh
kubernetes certificate approve <csr-name>
```
A Certificate will be generated by the Kubernetes Certificate Authority. The certificate is stored
in the status.certificate field of the CSR object). We can obtain it using this command -
```sh
kubectl get csr adam -o jsonpath='{.status.certificate}'| base64 -d > ./users/adam/certificate
```

I will then share the Kubernetes CSR object defintion file and the Certificate with Adam. Adam can
then modify his ~/.kube/config file using this command -
```sh
# Adding the user
kubectl config set-credentials adam --client-key=./users/adam/private-key --client-certificate=./users/adam/certificate --embed-certs=true

# Creating the context adn using that.
kubectl config set-context adam --cluster=main --user=adam && \
  kubectl config use-context adam
```

Hooraaayyyy, Adam is now a part of the Kubernetes team !!

Now, the Certificate has an expiration time. Let's give Adam permission to create (but not get) the
CSR by himself.
```sh
# Create the ClusterRole and ClusterRoleBinding.
kubectl apply -f ./yaml/roles/physical-user.yaml && \
  kubectl apply -f ./yaml/roles/bindings/adam/physical-user.yaml
```
So from next time, he can also create the Kubernetes CSR object. I just need to approve it and share
the generated Certificate with him.

Now, I will define the permissions for a database engineer using a Kubernetes `Role` and then bind the Role with Adam.
```sh
# Create the Role and RoleBinding.
kubectl apply -f ./yaml/roles/database-engineer.yaml && \
  kubectl apply -f ./yaml/roles/bindings/adam/database-engineer.yaml

# Create the database namespace
kubectl create namespace databases
```

Now, in real world scenarios, there will be lots of Roles, ClusterRoles, RoleBindings and
ClusterRoleBindings. To visualize them, you can install `Kubescape` and use their RBAC
visualizer. Use this command to install Kubescape -
```sh
helm repo add kubescape https://kubescape.github.io/helm-charts/ && \
  helm repo update && \
helm upgrade \
  --install kubescape kubescape/kubescape-operator \
  -n kubescape --create-namespace \
  --values ./yaml/helm/values/kubescape-operator.yaml
```

## Monitoring (Prometheus and Grafana)

```sh
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts && \
  helm repo update
kubectl create namespace prometheus
helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack \
  -n prometheus \
  --values ./yaml/helm/values/kube-prometheus-stack.yaml
```